#!/bin/bash
#==============================================================================
# rj_check_status - Monitor all running PTRA experiments
# Author: Antoine KDA
# Description: Comprehensive status checker for all experiments
#==============================================================================

# Configuration
EXPERIMENT_DIR="$HOME/projects/experiments"
PID_FILE="$EXPERIMENT_DIR/experiment.pid"
STATUS_FILE="$EXPERIMENT_DIR/experiment_status.txt"
MONITOR_LOG="$EXPERIMENT_DIR/experiment_monitor.log"
PROGRESS_FILE="$EXPERIMENT_DIR/experiment_progress.txt"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Function to format time duration
format_duration() {
    local T=$1
    local D=$((T/60/60/24))
    local H=$((T/60/60%24))
    local M=$((T/60%60))
    local S=$((T%60))
    (( $D > 0 )) && printf '%d days ' $D
    (( $H > 0 )) && printf '%d hours ' $H
    (( $M > 0 )) && printf '%d minutes ' $M
    (( $D > 0 || $H > 0 || $M > 0 )) && printf 'and '
    printf '%d seconds\n' $S
}

clear
echo "=========================================="
echo "  All Experiments Status Monitor"
echo "=========================================="
echo "Check time: $(date)"
echo ""

# Check if PID file exists
if [ ! -f "$PID_FILE" ]; then
    echo -e "${YELLOW}No experiments are currently tracked${NC}"
    echo "Launch experiments with: ./rj_run_job_nohup"
    exit 0
fi

# Read PID
PID=$(cat "$PID_FILE")

# Check if process is running
if ps -p $PID > /dev/null 2>&1; then
    echo -e "${GREEN}✓ ALL EXPERIMENTS ARE RUNNING${NC}"
    echo ""
    
    # Progress Information
    if [ -f "$PROGRESS_FILE" ]; then
        echo "=========================================="
        echo "  Experiments Progress"
        echo "=========================================="
        cat "$PROGRESS_FILE"
        echo ""
    fi
    
    # Process details
    echo "=========================================="
    echo "  Process Information"
    echo "=========================================="
    echo "PID: $PID"
    
    # Get process details
    PROCESS_INFO=$(ps -p $PID -o pid,ppid,%cpu,%mem,etime,cmd --no-headers)
    CPU=$(echo $PROCESS_INFO | awk '{print $3}')
    MEM=$(echo $PROCESS_INFO | awk '{print $4}')
    ETIME=$(echo $PROCESS_INFO | awk '{print $5}')
    
    echo "CPU Usage: ${CPU}%"
    echo "Memory Usage: ${MEM}%"
    echo "Runtime: $ETIME"
    echo ""
    
    # System resources
    echo "=========================================="
    echo "  System Resources"
    echo "=========================================="
    echo "System Load: $(cat /proc/loadavg | cut -d' ' -f1-3)"
    echo "Total Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
    echo "Available Memory: $(free -h | grep '^Mem:' | awk '{print $7}')"
    echo "Disk Space (experiment dir): $(df -h $EXPERIMENT_DIR | tail -1 | awk '{print $4 " free of " $2}')"
    echo ""
    
    # Log file info
    echo "=========================================="
    echo "  Master Log File"
    echo "=========================================="
    
    # Find most recent master log
    LATEST_LOG=$(ls -t $EXPERIMENT_DIR/all_experiments_*.log 2>/dev/null | head -1)
    if [ -n "$LATEST_LOG" ]; then
        echo "Log file: $LATEST_LOG"
        LOG_SIZE=$(du -h "$LATEST_LOG" | cut -f1)
        echo "Log size: $LOG_SIZE"
        echo "Last modified: $(stat -c %y "$LATEST_LOG" 2>/dev/null | cut -d. -f1 || stat -f %Sm "$LATEST_LOG")"
        
        echo ""
        echo "Last 15 lines of log:"
        echo "---"
        tail -15 "$LATEST_LOG"
        echo "---"
    else
        echo -e "${YELLOW}No log file found${NC}"
    fi
    echo ""
    
    # Monitor log
    if [ -f "$MONITOR_LOG" ]; then
        echo "=========================================="
        echo "  Resource Usage History"
        echo "=========================================="
        echo "Last 5 monitoring entries:"
        tail -5 "$MONITOR_LOG"
        echo ""
    fi
    
    # Status file
    if [ -f "$STATUS_FILE" ]; then
        echo "=========================================="
        echo "  Experiment Details"
        echo "=========================================="
        cat "$STATUS_FILE"
        echo ""
    fi
    
    # Output directories check
    echo "=========================================="
    echo "  Output Directories"
    echo "=========================================="
    for i in {1..7}; do
        OUTPUT_DIR="$HOME/projects/experiment${i}"
        if [ -d "$OUTPUT_DIR" ]; then
            FILE_COUNT=$(find "$OUTPUT_DIR" -type f 2>/dev/null | wc -l)
            DIR_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1)
            echo "Experiment $i: $FILE_COUNT files, $DIR_SIZE"
        fi
    done
    echo ""
    
    echo "=========================================="
    echo "  Commands"
    echo "=========================================="
    echo "Quick check:"
    echo "  ./rj_quick_check"
    echo ""
    echo "Follow master log:"
    echo "  tail -f $LATEST_LOG"
    echo ""
    echo "Watch live progress:"
    echo "  ./rj_watch_experiment"
    echo ""
    echo "View progress file:"
    echo "  cat $PROGRESS_FILE"
    echo ""
    echo "Stop all experiments:"
    echo "  ./rj_stop_experiment"
    echo ""
    
else
    echo -e "${RED}✗ EXPERIMENTS ARE NOT RUNNING${NC}"
    echo ""
    echo "PID $PID is not active"
    echo ""
    
    # Check progress file for completion status
    if [ -f "$PROGRESS_FILE" ]; then
        echo "=========================================="
        echo "  Final Progress"
        echo "=========================================="
        cat "$PROGRESS_FILE"
        echo ""
        
        STATUS=$(grep "^Status:" "$PROGRESS_FILE" | cut -d: -f2- | xargs)
        if [[ "$STATUS" == *"FINISHED"* ]]; then
            echo -e "${GREEN}✓ All experiments completed successfully!${NC}"
        else
            echo -e "${YELLOW}⚠ Experiments stopped unexpectedly${NC}"
        fi
        echo ""
    fi
    
    # Check last monitoring entry
    if [ -f "$MONITOR_LOG" ]; then
        echo "Last monitoring entry:"
        tail -1 "$MONITOR_LOG"
        echo ""
    fi
    
    # Check if log file exists
    LATEST_LOG=$(ls -t $EXPERIMENT_DIR/all_experiments_*.log 2>/dev/null | head -1)
    if [ -n "$LATEST_LOG" ]; then
        echo "Check master log for details:"
        echo "  tail -50 $LATEST_LOG"
        echo ""
        echo "Last 20 lines of log:"
        echo "---"
        tail -20 "$LATEST_LOG"
        echo "---"
        echo ""
    fi
    
    echo "To start new experiments:"
    echo "  ./rj_run_job_nohup"
    echo ""
    
    # Clean up PID file
    echo -e "${YELLOW}Cleaning up PID file...${NC}"
    rm -f "$PID_FILE"
fi

echo "=========================================="
