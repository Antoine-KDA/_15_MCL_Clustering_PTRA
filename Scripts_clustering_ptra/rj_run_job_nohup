#!/bin/bash
#==============================================================================
# Run_job_nohup - Launch and manage long-running PTRA experiment
# Author: Antoine KDA
# Description: Launches experiment as background job that survives SSH disconnect
# Expected runtime: 2-5 days
#==============================================================================

set -euo pipefail

# Configuration
EXPERIMENT_DIR="$HOME/projects/experiments"
SCRIPT_NAME="experiment_generic_full_population_analysis"
SCRIPT_PATH="$EXPERIMENT_DIR/$SCRIPT_NAME"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="$EXPERIMENT_DIR/experiment_${TIMESTAMP}.log"
PID_FILE="$EXPERIMENT_DIR/experiment.pid"
STATUS_FILE="$EXPERIMENT_DIR/experiment_status.txt"
MONITOR_LOG="$EXPERIMENT_DIR/experiment_monitor.log"

# Create necessary directories
mkdir -p "$EXPERIMENT_DIR"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo "=========================================="
echo "  PTRA Experiment Job Launcher"
echo "=========================================="
echo "Started at: $(date)"
echo ""

# Check if experiment script exists
if [ ! -f "$SCRIPT_PATH" ]; then
    echo -e "${RED}ERROR: Experiment script not found at $SCRIPT_PATH${NC}"
    exit 1
fi

# Check if job is already running
if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if ps -p "$OLD_PID" > /dev/null 2>&1; then
        echo -e "${YELLOW}WARNING: Experiment is already running (PID: $OLD_PID)${NC}"
        echo "Use './check_experiment_status' to monitor"
        echo "Or kill with: kill $OLD_PID"
        exit 1
    else
        echo "Removing stale PID file..."
        rm -f "$PID_FILE"
    fi
fi

# Make script executable
chmod +x "$SCRIPT_PATH"
echo -e "${GREEN}✓${NC} Script is executable"

# Record start information
cat > "$STATUS_FILE" << EOF
Experiment Status
=================
Script: $SCRIPT_NAME
Started: $(date)
PID: (will be updated after launch)
Log: $LOG_FILE
Host: $(hostname)
User: $USER
EOF

echo ""
echo "Launching experiment in background..."
echo "Expected runtime: 2-5 days"
echo ""

# Launch with nohup
nohup "$SCRIPT_PATH" > "$LOG_FILE" 2>&1 &

# Save PID
EXPERIMENT_PID=$!
echo $EXPERIMENT_PID > "$PID_FILE"

# Update status file with PID
sed -i "s/PID: (will be updated after launch)/PID: $EXPERIMENT_PID/" "$STATUS_FILE"

# Wait a moment to ensure process started
sleep 2

# Verify process is running
if ps -p $EXPERIMENT_PID > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Experiment launched successfully!${NC}"
else
    echo -e "${RED}✗ ERROR: Process failed to start${NC}"
    echo "Check log file: $LOG_FILE"
    exit 1
fi

# Start monitoring daemon in background
echo "Starting automatic monitoring..."
cat > "$EXPERIMENT_DIR/monitor_daemon.sh" << 'MONITOR_EOF'
#!/bin/bash
PID_FILE="$HOME/projects/experiments/experiment.pid"
MONITOR_LOG="$HOME/projects/experiments/experiment_monitor.log"

if [ ! -f "$PID_FILE" ]; then
    exit 0
fi

PID=$(cat "$PID_FILE")

while ps -p $PID > /dev/null 2>&1; do
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    CPU=$(ps -p $PID -o %cpu= | xargs)
    MEM=$(ps -p $PID -o %mem= | xargs)
    TIME=$(ps -p $PID -o etime= | xargs)
    
    echo "$TIMESTAMP | PID: $PID | CPU: ${CPU}% | MEM: ${MEM}% | Runtime: $TIME" >> "$MONITOR_LOG"
    
    sleep 300  # Log every 5 minutes
done

# Process ended, log final status
echo "$(date '+%Y-%m-%d %H:%M:%S') | Process $PID ended" >> "$MONITOR_LOG"
MONITOR_EOF

chmod +x "$EXPERIMENT_DIR/monitor_daemon.sh"
nohup "$EXPERIMENT_DIR/monitor_daemon.sh" > /dev/null 2>&1 &

echo -e "${GREEN}✓ Monitoring daemon started${NC}"
echo ""

# Display summary
echo "=========================================="
echo "  Job Information"
echo "=========================================="
echo "Process ID (PID): $EXPERIMENT_PID"
echo "Log file: $LOG_FILE"
echo "Status file: $STATUS_FILE"
echo "Monitor log: $MONITOR_LOG"
echo ""
echo "=========================================="
echo "  Quick Commands"
echo "=========================================="
echo "Check if running:"
echo "  ps -p $EXPERIMENT_PID"
echo ""
echo "View live log:"
echo "  tail -f $LOG_FILE"
echo ""
echo "Check status:"
echo "  ./rj_quick_check"
echo ""
echo "Monitor resource usage:"
echo "  tail -f $MONITOR_LOG"
echo ""
echo "Stop experiment:"
echo "  ./rj_stop_experiment"
echo ""
echo "=========================================="
echo ""
echo -e "${GREEN}Experiment is now running in background${NC}"
echo "You can safely close this SSH session"
echo ""
echo "Quick check: ./rj_quick_check"
echo "Watch live: ./rj_watch_experiment"
echo ""

# Display first few lines of log
echo "Initial log output:"
echo "---"
sleep 1
head -20 "$LOG_FILE" 2>/dev/null || echo "(Log file not yet populated)"
echo "---"
echo ""
echo "Use 'tail -f $LOG_FILE' to follow progress"
echo ""