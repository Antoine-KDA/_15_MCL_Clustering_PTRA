#!/bin/bash
#==============================================================================
# watch_experiment - Continuously monitor experiment progress
# Author: Antoine KDA
# Description: Real-time monitoring dashboard for running experiment
#==============================================================================

EXPERIMENT_DIR="$HOME/projects/experiments"
PID_FILE="$EXPERIMENT_DIR/experiment.pid"
REFRESH_INTERVAL=5  # seconds

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check if experiment is running
if [ ! -f "$PID_FILE" ]; then
    echo "No experiment running"
    exit 1
fi

PID=$(cat "$PID_FILE")

if ! ps -p $PID > /dev/null 2>&1; then
    echo "Experiment process (PID: $PID) is not running"
    exit 1
fi

echo "Starting live monitoring... (Press Ctrl+C to stop)"
echo ""

# Main monitoring loop
while ps -p $PID > /dev/null 2>&1; do
    clear
    echo "=========================================="
    echo "  LIVE EXPERIMENT MONITOR"
    echo "=========================================="
    echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "PID: $PID"
    echo "Refresh: ${REFRESH_INTERVAL}s"
    echo ""
    
    # Process stats
    PROC_INFO=$(ps -p $PID -o %cpu,%mem,etime --no-headers)
    CPU=$(echo $PROC_INFO | awk '{print $1}')
    MEM=$(echo $PROC_INFO | awk '{print $2}')
    RUNTIME=$(echo $PROC_INFO | awk '{print $3}')
    
    echo "CPU: ${CPU}%  |  Memory: ${MEM}%  |  Runtime: $RUNTIME"
    echo ""
    
    # System stats
    echo "System Load: $(uptime | awk -F'load average:' '{print $2}')"
    echo "Memory: $(free -h | grep '^Mem:' | awk '{print $3 " / " $2 " (" $7 " available)"}')"
    echo ""
    
    # Log tail
    LATEST_LOG=$(ls -t $EXPERIMENT_DIR/experiment_*.log 2>/dev/null | head -1)
    if [ -n "$LATEST_LOG" ]; then
        LOG_SIZE=$(du -h "$LATEST_LOG" | cut -f1)
        echo "Log: $LOG_SIZE | $(basename $LATEST_LOG)"
        echo "---"
        tail -15 "$LATEST_LOG"
        echo "---"
    fi
    
    echo ""
    echo "Press Ctrl+C to stop monitoring"
    
    sleep $REFRESH_INTERVAL
done

echo ""
echo -e "${RED}Experiment process has ended${NC}"
echo "Check status with: ./rj_check_status"
